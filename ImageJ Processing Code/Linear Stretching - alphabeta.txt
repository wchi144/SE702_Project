//bit depth = 16 or 8
var depth = bitDepth();

//maxVal
var maxVal = pow(2, depth)-1;

width = getWidth();
height = getHeight();


Dialog.create("Enter threshold percentiles");
Dialog.addMessage("Enter threshold percentiles.");
Dialog.addNumber("Min: ", 0.01); //0.01
Dialog.addNumber("Max: ", 99.99); //99.99
Dialog.show();
amin= Dialog.getNumber();
bmax= Dialog.getNumber();



//Q2A SKELETON CODE

print("Linear stretching, Begin, please wait...");
original = imageToArray();	
LinStretch = LS(original, getWidth(), getHeight(), amin, bmax);	
arrayToImage(LinStretch);
print("Done");
updateDisplay();

function imageToArray() {
	height = getHeight();
	width = getWidth();
	a = newArray(width * height);
	for (y = 0; y < height; y++) {
		for (x = 0; x < width; x++) {
			a[y * getWidth() + x] = getPixel(x, y);
		}
	}
	return a;
}

// writes an array to the active image
function arrayToImage(array) {
	width = getWidth();
	height = getHeight();
	for (y = 0; y < height; y++) {
		for (x = 0; x < width; x++) {
			setPixel(x, y, array[y * width + x]);
		}
	}
}

//implement your code here

// performs Linear stretching as per Q2_a on array, returns output array and does not alter input array.
function LS(array, width, height, amin, bmax) {	
	out = newArray(array.length);
	//implement your code here
	
	//Create the histogram
	cHisto = newArray(maxVal+1);
	for(i = 0; i < lengthOf(array); i++){
		cHisto[array[i]] = cHisto[array[i]] + 1;
	}

	//Calculate the alpha and beta percentile.	
	alphathreshold = ((amin)/100)*array.length;
	betathreshold = ((bmax)/100)*array.length;

	
	gmin = 0;
	gmax = maxVal;
	fmin = 55;
	fmax = 55555;

	//Find fmin that is greater than alphathreshold
	acount = 0;
	for(j = 0; j < lengthOf(cHisto); j++){
		if(acount > alphathreshold){
			fmin = j;
			print("value for alpha: " + j);
			j = lengthOf(cHisto);
		}
		else{
			acount += cHisto[j];
		}
	}

	//find fmax that is smaller than betathreshold
	bcount = array.length-1;
	for(k = lengthOf(cHisto)-1; k > 0; k--){
		if(bcount < betathreshold){
			fmax = k;
			print("value for beta: " + k);
			k = 0;
		}
		else{
			bcount -= cHisto[k];
		}	
	}

	//Create array of new stretched pixels
	for(l = 0; l < lengthOf(array); l++){
		out[l] = adjust(array[l], gmin, gmax, fmin, fmax);
	}
	
	return out;
}

//Calculate pixel g
function adjust(pixelv, gmin, gmax, fmin, fmax){

	a = pixelv - fmin;
	b = (gmax - gmin)/(fmax-fmin);
	s = (a*b) + gmin;

	if(s < gmin){
		g = gmin;
	}
	else if(s <= gmax){
		g = s;
	}
	else if(s > gmax){
		g = gmax;
	}

	return g;
}